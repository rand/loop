# M2 - REPL Protocol and Typed-Signature Closure

## Objective

Close the Rust/Python REPL protocol gap for typed signatures and SUBMIT semantics defined in SPEC-20.

## Entry Criteria

- M1 complete, including stable REPL spawn path.
- D-005 approved.

## Exit Criteria

- Python JSON-RPC server supports `register_signature` and `clear_signature`.
- Sandbox supports `SUBMIT(outputs)` with validation and immediate termination semantics.
- Rust `ExecuteResult.submit_result` is populated correctly for submit scenarios.
- Typed-submit scenario suite passes.

## Task Cards

### M2-T01 Add `register_signature` and `clear_signature` JSON-RPC Handlers

- Goal: match Rust client protocol methods used by `rlm-core/src/repl.rs`.
- Work items:
- Extend Python protocol/request validation as needed.
- Add server handlers in `rlm-core/python/rlm_repl/main.py`.
- Add state storage for active signature registration.
- Acceptance criteria:
- Methods return success and mutate signature state correctly.
- Unknown signature state transitions are handled safely.
- Required gates: VG-LOOP-REPL-001, VG-LOOP-REPL-002

### M2-T02 Implement Sandbox `SUBMIT(outputs)` Path

- Goal: allow REPL code to terminate with structured outputs.
- Work items:
- Add `SUBMIT` callable to sandbox globals.
- Implement controlled termination mechanism for SUBMIT (non-generic exception path).
- Validate output fields against registered signature.
- Acceptance criteria:
- SUBMIT without signature returns clear validation failure.
- Missing field and type mismatch errors are structured.
- Multiple SUBMIT calls are handled per policy.
- Required gates: VG-LOOP-REPL-001, VG-EFFICACY-001

### M2-T03 Populate `ExecuteResponse` / Rust `ExecuteResult.submit_result`

- Goal: return structured submit results across process boundary.
- Work items:
- Extend Python `ExecuteResponse` schema for `submit_result` payload.
- Ensure Rust deserialization and behavior remain stable.
- Acceptance criteria:
- Successful submit case produces parsed `submit_result` on Rust side.
- Validation-error case is represented and test-covered.
- Required gates: VG-LOOP-SIG-001, VG-EFFICACY-001

### M2-T04 Add End-to-End Typed-Submit Integration Tests

- Goal: lock behavior with scenario-based tests.
- Required scenarios:
- Registered signature + valid submit.
- Registered signature + missing field.
- Registered signature + type mismatch.
- No registered signature.
- Multiple SUBMIT calls in one execution.
- Acceptance criteria:
- Scenario suite passes locally and in CI context.
- Required gates: VG-LOOP-REPL-002, VG-EFFICACY-001

### M2-T05 Align Runtime Protocol Documentation

- Goal: ensure specs and runtime protocol docs describe actual behavior.
- Work items:
- Update SPEC-20 sections impacted by runtime contract details.
- Ensure file paths and protocol messages match implementation.
- Acceptance criteria:
- No open drift item remains for typed-signature protocol.
- Required gates: VG-DOC-SPEC-001

## Risks

- SUBMIT termination mechanism can accidentally catch unrelated exceptions if not isolated.
- Validation schema mismatch between Python and Rust may silently drop fields if not tested end-to-end.

## Handoff Notes

At M2 completion, proceed to `M3-T01`.

