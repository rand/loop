# M7 - Spec Completion and Integration Hardening

## Objective

Close the remaining implementation gaps identified in SPEC-20 through SPEC-27 and outstanding consumer-interoperability follow-ups, with explicit validation gates per task and evidence-first delivery.

This milestone is a `dp-codex` execution tranche derived from a constrained decomposition pass (context window `1024`) to keep tasks Codex/Claude-executable in small sessions.

## Entry Criteria

- M6 complete and cadence controls active.
- D-017 clean-clone committed-tuple policy remains in force for compatibility claims.
- G-001 and G-002 from `M3-T04-spec-test-traceability.md` still open.

## Exit Criteria

- SPEC-20..SPEC-27 items below are implemented or explicitly moved to up-next critical scope with accepted decision records.
- Remaining runtime gaps are closed with deterministic test evidence.
- `io-rflx` adapter fixtures and benchmark calibration are implemented and validated.
- M7 minimum gate set passes with evidence artifacts under `docs/execution-plan/evidence/<date>/milestone-M7/`.

## dp-codex Decomposition Mapping

- Source artifact: `docs/execution-plan/evidence/2026-02-19/milestone-M7/M7-dp-decompose-context1024.json`
- Node-to-task mapping:
- `T1 -> M7-T01`
- `T2 -> M7-T02`
- `T3 -> M7-T03`
- `T4 -> M7-T04`
- `T5 -> M7-T05`
- `T6 -> M7-T06`
- `T7 -> M7-T07`
- `T8 -> M7-T08`
- `T9 -> M7-T09`
- `T10 -> M7-T10`

## Task Cards

### M7-T01 SPEC-26 End-to-End `LLM_BATCH` Runtime Closure

- Tracking issue: `loop-bih.1`
- Goal: complete Rust REPL-host orchestration for batched operations and validate end-to-end behavior.
- Scope:
- `rlm-core/src/repl.rs`
- `rlm-core/python/rlm_repl/{main.py,protocol.py,sandbox.py,helpers.py}`
- `rlm-core/python/tests/test_repl.py`
- Acceptance criteria:
- Host-level batched execution path is wired and tested for success and mixed-failure resolution.
- `llm_batch` remains canonical and `llm_query_batched` compatibility behavior is preserved.
- Required gates: `VG-LOOP-BATCH-001`, `VG-LOOP-REPL-001`, `VG-EFFICACY-001`

### M7-T02 SPEC-27 Orchestrator Fallback Wiring

- Tracking issue: `loop-bih.2`
- Goal: wire fallback extraction primitives into orchestrator execution loop with deterministic trigger behavior.
- Scope:
- `rlm-core/src/orchestrator.rs`
- `rlm-core/src/signature/fallback.rs`
- `rlm-core/src/repl.rs`
- Acceptance criteria:
- Max-iteration / max-LLM-call / timeout paths execute fallback extraction when no submit is present.
- Structured output contract remains valid for fallback-generated results.
- Required gates: `VG-LOOP-FALLBACK-001`, `VG-EFFICACY-001`, `VG-LOOP-SIG-001`

### M7-T03 SPEC-20 Typed-Signature Parity

- Tracking issue: `loop-bih.3`
- Goal: close typed-signature parity gaps (enum inference behavior and input validation before execution).
- Scope:
- `rlm-core-derive/src/lib.rs`
- `rlm-core/src/module/predict.rs`
- `rlm-core/src/signature/*`
- Acceptance criteria:
- Enum-like outputs/inputs are represented per accepted field-type semantics.
- Input validation errors are deterministic and occur pre-execution.
- Required gates: `VG-LOOP-SIG-002`, `VG-LOOP-SIG-001`, `VG-EFFICACY-001`

### M7-T04 SPEC-21 Dual-Model Orchestrator Integration

- Tracking issue: `loop-bih.4`
- Goal: connect dual-model routing to orchestration/runtime mode boundaries and close accepted API drift.
- Scope:
- `rlm-core/src/llm/router.rs`
- `rlm-core/src/orchestrator.rs`
- `rlm-core/src/proof/*` (if routing context intersects proof paths)
- Acceptance criteria:
- Dual-model config is applied by orchestration paths, not just isolated router helpers.
- Tiered-cost accounting remains correct across root/recursive/extraction calls.
- Required gates: `VG-LOOP-DUAL-001`, `VG-LOOP-CORE-001`, `VG-PERF-002`

### M7-T05 SPEC-22 Proof Protocol Execution Closure

- Tracking issue: `loop-bih.5`
- Goal: replace proof-engine placeholders with concrete execution and persistence behavior.
- Scope:
- `rlm-core/src/proof/engine.rs`
- `rlm-core/src/proof/session.rs`
- `rlm-core/src/proof/ai_assistant.rs` (integration touchpoint as needed)
- Acceptance criteria:
- Previously placeholder branches are implemented or explicitly decision-gated.
- Learning/session persistence behavior is test-covered.
- Required gates: `VG-LOOP-PROOF-001`, `VG-EFFICACY-001`

### M7-T06 SPEC-23 Graph Visualization Integration

- Tracking issue: `loop-bih.6`
- Goal: complete visualization integration surfaces promised by spec and close export parity gaps.
- Scope:
- `rlm-core/src/reasoning/visualize.rs`
- Consumer-facing integration points in CLI/TUI/MCP layers (as scoped by accepted contract)
- Acceptance criteria:
- Mermaid-enhanced export or explicitly approved alternative is implemented.
- Integration endpoints are documented and tested with deterministic fixtures.
- Required gates: `VG-LOOP-VIZ-001`, `VG-DOC-SPEC-002`

### M7-T07 SPEC-24 Bootstrap Optimizer Completion

- Tracking issue: `loop-bih.7`
- Goal: complete optimizer parity (reasoning capture, persistence helpers, metric model alignment).
- Scope:
- `rlm-core/src/module/optimize.rs`
- Supporting metric/persistence modules under `rlm-core/src/module/`
- Acceptance criteria:
- Reasoning capture is implemented without TODO placeholders.
- Persistence and metric APIs match accepted contract and are test-covered.
- Required gates: `VG-LOOP-OPT-001`, `VG-EFFICACY-001`, `VG-PERF-003`

### M7-T08 SPEC-25 Context Externalization Contract Completion

- Tracking issue: `loop-bih.8`
- Goal: align runtime prompt contract and helper behavior with spec requirements.
- Scope:
- `rlm-core/src/context/externalize.rs`
- `rlm-core/python/rlm_repl/helpers.py`
- `docs/spec/SPEC-25-context-externalization.md`
- Acceptance criteria:
- Root prompt contract includes submit instruction semantics required by SPEC-25.
- Generated helper guidance and runtime docs remain internally consistent.
- Required gates: `VG-LOOP-CONTEXT-001`, `VG-LOOP-REPL-001`, `VG-DOC-SPEC-002`

### M7-T09 io-rflx Adapter Fixture + Calibration Delivery

- Tracking issue: `loop-bih.9`
- Goal: implement previously queued interop fixtures and benchmark calibration.
- Scope:
- `docs/execution-plan/contracts/IO-RFLX-INTEROP-CONTRACT.md`
- adapter fixture assets and calibration scripts/artifacts for `io-rflx`
- Acceptance criteria:
- Roundtrip fixture set exists for provenance, trajectory, and verification envelopes.
- Calibration method and threshold policy are documented and repeatable.
- Required gates: `VG-RFLX-001`, `VG-RFLX-002`, `VG-PERF-003`, `VG-CONTRACT-001`

### M7-T10 Spec/Governance Reconciliation and Promotion

- Tracking issue: `loop-bih.10`
- Goal: reconcile spec status metadata, acceptance checklists, and traceability evidence after implementation closure.
- Scope:
- `docs/spec/SPEC-20-typed-signatures.md`
- `docs/spec/SPEC-21-dual-model-optimization.md`
- `docs/spec/SPEC-22-proof-protocol.md`
- `docs/spec/SPEC-23-graph-visualization.md`
- `docs/spec/SPEC-24-bootstrap-optimizer.md`
- `docs/spec/SPEC-25-context-externalization.md`
- `docs/spec/SPEC-26-batched-queries.md`
- `docs/spec/SPEC-27-fallback-extraction.md`
- `docs/execution-plan/STATUS.md`
- `docs/execution-plan/TASK-REGISTRY.md`
- Acceptance criteria:
- Spec status fields and implementation snapshots match runtime reality.
- Residual gap register is either closed or explicitly tied to new tracked tasks.
- Required gates: `VG-DOC-SPEC-002`, `VG-CONTRACT-001`, `VG-RCC-001`, `VG-LA-001`, `VG-RFLX-001`

## Risks

- Cross-cutting runtime edits (orchestrator, REPL, optimizer, proof) can destabilize consumer compatibility if sequencing is skipped.
- Graph/proof/optimizer completions may exceed small-session scope without strict task slicing.
- `io-rflx` calibration can drift without stable fixture schema versioning.

## Sequencing Policy

- Execute one task card at a time in strict order `M7-T01 -> M7-T10` unless orchestrator approves a dependency-safe reorder.
- Keep heavy command concurrency at `1` and run heavy gates through `/Users/rand/src/loop/scripts/safe_run.sh`.
- Any scope expansion beyond the task card requires a tracker update before implementation.
