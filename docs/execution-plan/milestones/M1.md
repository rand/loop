# M1 - Build and Toolchain Integrity

## Objective

Restore deterministic baseline health for `rlm-core` across expected feature profiles and REPL startup environments.

## Entry Criteria

- M0-T02 approved.
- M0-T03 approved for entrypoint strategy.

## Exit Criteria

- `cargo check` passes in baseline profiles (default, no-default, gemini).
- REPL spawn integration test (`test_repl_spawn`) passes.
- CI matrix enforces baseline profiles.
- Full `rlm-core` gemini-profile regression suite is stabilized.

## Task Cards

### M1-T01 Fix `rlm_available_features()` Compile Failure

- Goal: remove cfg-dependent type inference failure at `rlm-core/src/ffi/mod.rs:152`.
- Work items:
- Make `features` vector type explicit and stable under no-feature builds.
- Add or update regression test for feature list behavior.
- Acceptance criteria:
- VG-LOOP-BUILD-001 passes.
- VG-LOOP-BUILD-002 passes.
- VG-LOOP-BUILD-003 passes.
- Required gates: VG-LOOP-BUILD-001, VG-LOOP-BUILD-002, VG-LOOP-BUILD-003

### M1-T02 Add Feature-Matrix CI Checks

- Goal: prevent regressions in baseline build profiles.
- Work items:
- Add CI jobs for baseline profiles.
- Ensure failure output points to profile that failed.
- Acceptance criteria:
- CI config includes all baseline profiles.
- Local/manual run commands map to VG IDs.
- Required gates: VG-LOOP-BUILD-001, VG-LOOP-BUILD-002, VG-LOOP-BUILD-003

### M1-T03 Make REPL Spawn Entrypoint Robust

- Goal: make REPL startup reliable for both dev and packaged environments.
- Work items:
- Implement D-003 strategy (`python -m rlm_repl` support and/or script fallback).
- Ensure `ReplConfig` path handling is documented and tested.
- Acceptance criteria:
- `test_repl_spawn` succeeds in intended environment.
- Spawn error messages are actionable if environment is misconfigured.
- Required gates: VG-LOOP-REPL-002

### M1-T04 Improve REPL Spawn Diagnostics and Docs

- Goal: reduce time-to-debug for Python process startup failures.
- Work items:
- Include stderr/context in spawn failure path where safe.
- Update Python REPL README/startup docs to match real invocation path.
- Acceptance criteria:
- Documentation and runtime behavior align.
- Required gates: VG-LOOP-REPL-002, VG-DOC-SPEC-001

### M1-T05 Triage and Stabilize Failing `rlm-core` Regression Tests

- Goal: restore confidence in broader `rlm-core` behavior before integration milestones.
- Work items:
- Reproduce failing tests from baseline run and categorize by subsystem.
- Fix or quarantine only with explicit rationale and follow-up tasks.
- Add focused regression tests where root causes were missing coverage.
- Acceptance criteria:
- `cargo test --no-default-features --features gemini` passes.
- No untracked test quarantine remains.
- Required gates: VG-LOOP-CORE-001

## Sequencing

- Execute M1-T01 before all other M1 tasks.
- M1-T03 depends on M0-T03 decision approval.

## Risks

- Environment-sensitive REPL startup may mask real contract issues if diagnostics remain weak.

## Handoff Notes

M1 is complete. Next execution start point is `M3-T01`.
